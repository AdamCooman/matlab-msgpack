classdef TestDump < matlab.unittest.TestCase
    methods (Test)
        function test_integers(test)
            value_pack_pairs = {
                uint8(1), uint8(1);
                uint8(128), uint8([204, 128]);
                uint16(256), uint8([205, 1, 0]);
                uint32(2^16), uint8([206, 0, 1, 0, 0]);
                uint64(2^32), uint8([207, 0, 0, 0, 1, 0, 0, 0, 0]);
                int8(0), uint8(0);
                int8(-1), uint8(255);
                int8(-128), uint8([208, 128]);
                int16(-256), uint8([209, 255, 0]);
                int32(-2^16), uint8([210, 255, 255, 0, 0]);
                int64(-2^32), uint8([211, 255, 255, 255, 255, 0, 0, 0, 0]);
            };
            for tt = 1 : size(value_pack_pairs,1)
                test.assertEqual( ...
                    msgpack.dump(value_pack_pairs{tt,1}), ...
                    value_pack_pairs{tt,2})
            end
        end
        function test_float(test)
            value_pack_pairs = {
                single(1.5), uint8([202, 63, 192, 0, 0]);
                double(1.5), uint8([203, 63, 248, 0, 0, 0, 0, 0, 0]);
                };
            for tt = 1 : size(value_pack_pairs,1)
                test.assertEqual( ...
                    msgpack.dump(value_pack_pairs{tt,1}), ...
                    value_pack_pairs{tt,2})
            end
        end
        function test_charvector(test)
            test.assertEqual( ...
                msgpack.dump('foo') , ...
                uint8([163, 102, 111, 111]))
            test.assertEqual( ...
                msgpack.dump(repmat('a', [1, 32])), ...
                uint8([217, 32, ones(1, 32)*'a']))
            test.assertEqual( ...
                msgpack.dump(repmat('a', [1, 2^8])) , ...
                uint8([218, 1, 0, ones(1, 2^8)*'a']))
            test.assertEqual( ...
                msgpack.dump(repmat('a', [1, 2^16])) , ...
                uint8([219, 0, 1, 0, 0, ones(1, 2^16)*'a']))
        end
        function test_string(test)
            test.assertEqual( ...
                msgpack.dump("foo") , ...
                uint8([163, 102, 111, 111]))
            test.assertEqual( ...
                msgpack.dump(string(repmat('a', [1, 32]))), ...
                uint8([217, 32, ones(1, 32)*'a']))
            test.assertEqual( ...
                msgpack.dump(string(repmat('a', [1, 2^8]))) , ...
                uint8([218, 1, 0, ones(1, 2^8)*'a']))
            test.assertEqual( ...
                msgpack.dump(string(repmat('a', [1, 2^16]))) , ...
                uint8([219, 0, 1, 0, 0, ones(1, 2^16)*'a']))
        end
        function test_array(test)
            test.assertEqual( ...
                msgpack.dump({uint8(1), uint8(2)}), ...
                uint8([146, 1, 2]));
            % array16
            test.assertEqual( ...
                msgpack.dump(num2cell(repmat(uint8(42), [1, 16]))) , ...
                uint8([220, 0, 16, repmat(42, [1, 16])]))
            % array32
            test.assertEqual( ...
                msgpack.dump(num2cell(repmat(uint8(42), [1, 2^16]))) , ...
                uint8([221, 0, 1, 0, 0, repmat(42, 1, 2^16)]))
        end
        function test_map(test)
            test.assertEqual( ...
                msgpack.dump(struct('one', uint8(1), 'two', uint8(2))) , ...
                uint8([130, msgpack.dump('one'), 1, msgpack.dump('two'), 2]))
            % map16
            data = struct();
            pack = uint8([222, 0, 16]);
            for n = 1 : 16
                value = int8(n);
                data.("x"+n) = value;
                pack = [pack,...
                    msgpack.dump("x"+n),...
                    msgpack.dump(value)];%#ok
            end
            test.assertEqual( ...
                msgpack.dump(data) , ...
                pack)
            % map32
            data = struct();
            pack = uint8([223, 0, 1, 0, 0]);
            for n = 1 : 2^16
                value = int8(n);
                data.("x"+n) = value;
                pack = [pack,...
                    msgpack.dump("x"+n),...
                    msgpack.dump(value)];%#ok
            end
            test.assertEqual( ...
                msgpack.dump(data) , ...
                pack)
        end
    end

end